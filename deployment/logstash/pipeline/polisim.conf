# Logstash Pipeline Configuration for PoliSim
# Phase 6.7.2: Structured Logging + Aggregation Pipeline

input {
  # Beats input (from Filebeat)
  beats {
    port => 5044
  }
  
  # Direct file input (backup if Filebeat unavailable)
  file {
    path => "/var/log/polisim/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    tags => ["polisim", "direct"]
  }
}

filter {
  # Parse JSON logs from PoliSim
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
    }
    
    # Promote parsed fields to top level
    if [parsed] {
      mutate {
        rename => {
          "[parsed][timestamp]" => "log_timestamp"
          "[parsed][level]" => "log_level"
          "[parsed][event]" => "event_type"
          "[parsed][event_category]" => "event_category"
          "[parsed][request_id]" => "request_id"
          "[parsed][user_id]" => "user_id"
          "[parsed][api_key_id]" => "api_key_id"
          "[parsed][route]" => "route"
          "[parsed][method]" => "http_method"
          "[parsed][status_code]" => "status_code"
          "[parsed][latency_ms]" => "latency_ms"
          "[parsed][env]" => "environment"
          "[parsed][service]" => "service_name"
          "[parsed][simulation_id]" => "simulation_id"
          "[parsed][extraction_id]" => "extraction_id"
          "[parsed][policy_id]" => "policy_id"
          "[parsed][scenario_id]" => "scenario_id"
        }
        remove_field => ["parsed"]
      }
    }
  }
  
  # Parse timestamp
  if [log_timestamp] {
    date {
      match => ["log_timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }
  
  # Add geo-ip for client IPs (if present)
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Categorize by log level
  if [log_level] == "ERROR" or [log_level] == "CRITICAL" {
    mutate {
      add_tag => ["error"]
    }
  }
  
  # Categorize security events
  if [event_category] == "auth" or [event_category] == "security" or [event_category] == "rate_limit" {
    mutate {
      add_tag => ["security"]
    }
  }
  
  # Add index name suffix based on environment
  if [environment] {
    mutate {
      add_field => { "[@metadata][env]" => "%{environment}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][env]" => "unknown" }
    }
  }
  
  # Remove sensitive fields (additional safety)
  mutate {
    remove_field => ["password", "token", "secret", "api_key", "authorization"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "polisim-logs-%{[@metadata][env]}-%{+YYYY.MM.dd}"
    document_id => "%{request_id}"
  }
  
  # Output errors to separate index for faster alerting
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "polisim-errors-%{[@metadata][env]}-%{+YYYY.MM.dd}"
    }
  }
  
  # Output security events to separate index
  if "security" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "polisim-security-%{[@metadata][env]}-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (disable in production)
  # stdout { codec => rubydebug }
}
